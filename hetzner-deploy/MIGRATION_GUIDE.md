# Supabase Migration Guide

This guide explains how to apply database migrations for the TradeMatrix project.

---

## üìã Available Migrations

### Current Migrations

1. **001_initial_schema.sql** - Initial database schema (users, markets, trades, etc.)
2. **002_rls_policies.sql** - Row Level Security policies
3. **003_eod_data.sql** - EOD (End of Day) price data tables
4. **004_eod_levels.sql** - EOD levels (High/Low, Pivot Points)
5. **012_liquidity_alerts.sql** - Liquidity alert system
6. **013_chart_snapshots.sql** - Chart snapshot storage ‚≠ê NEW

### Migration 013: Chart Snapshots (Required for Deployment)

**File:** `services/api/supabase/migrations/013_chart_snapshots.sql`

This migration adds support for storing TradingView chart snapshots generated by the ChartGenerator.

**What it does:**
- Creates `chart_snapshots` table
- Stores chart URLs, metadata, trigger types
- Tracks API usage for chart-img.com
- Enables RLS policies for security

---

## üöÄ How to Apply Migrations

### Option 1: Supabase Dashboard (Recommended)

This is the easiest method and works for all migrations.

#### Step 1: Access SQL Editor

1. Go to [Supabase Dashboard](https://supabase.com/dashboard)
2. Select your project
3. Click on **SQL Editor** in the left sidebar
4. Click **New Query**

#### Step 2: Copy Migration SQL

```bash
# On your local machine or server
cat services/api/supabase/migrations/013_chart_snapshots.sql
```

Copy the entire SQL content.

#### Step 3: Paste and Run

1. Paste the SQL into the SQL Editor
2. Click **Run** (or press `Cmd/Ctrl + Enter`)
3. Wait for confirmation: "Success. No rows returned"

#### Step 4: Verify

Run this verification query:

```sql
-- Check if table exists
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name = 'chart_snapshots';

-- Check table structure
\d chart_snapshots;

-- Check RLS policies
SELECT * FROM pg_policies
WHERE tablename = 'chart_snapshots';
```

**Expected output:**
- Table `chart_snapshots` exists
- 11 columns (id, symbol, timeframe, chart_url, etc.)
- RLS policies enabled

---

### Option 2: Supabase CLI

Use this method if you prefer command-line tools.

#### Prerequisites

```bash
# Install Supabase CLI
npm install -g supabase

# Login
supabase login

# Link to your project
supabase link --project-ref <your-project-ref>
```

#### Apply Migration

```bash
# Navigate to project root
cd /path/to/TradeMatrix

# Apply specific migration
supabase db push

# OR apply all pending migrations
supabase db push --include-all
```

#### Verify

```bash
# Check migration status
supabase db diff

# Should show: "No changes detected"
```

---

### Option 3: Direct Database Connection (Advanced)

Only use this if you have direct PostgreSQL access.

```bash
# Get connection string from Supabase Dashboard
# Settings > Database > Connection String (Direct)

psql "postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:5432/postgres"

# Inside psql
\i services/api/supabase/migrations/013_chart_snapshots.sql
```

---

## ‚úÖ Verification Steps

After applying any migration, run these checks:

### 1. Table Exists

```sql
SELECT COUNT(*) FROM chart_snapshots;
-- Should return: 0 (empty table, but exists)
```

### 2. Columns Are Correct

```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'chart_snapshots'
ORDER BY ordinal_position;
```

**Expected columns:**
1. `id` (uuid)
2. `symbol` (varchar)
3. `timeframe` (varchar)
4. `chart_url` (text)
5. `trigger_type` (varchar)
6. `trigger_metadata` (jsonb)
7. `generated_at` (timestamptz)
8. `api_provider` (varchar)
9. `api_usage_count` (integer)
10. `user_id` (uuid)
11. `created_at` (timestamptz)

### 3. RLS Policies Enabled

```sql
SELECT schemaname, tablename, rowsecurity
FROM pg_tables
WHERE tablename = 'chart_snapshots';
```

**Expected:** `rowsecurity = true`

### 4. Insert Test Data

```sql
-- Test insert (will fail if RLS is correct and you're not authenticated)
INSERT INTO chart_snapshots (
    symbol,
    timeframe,
    chart_url,
    trigger_type
) VALUES (
    'DAX',
    '4H',
    'https://chart-img.com/test.png',
    'manual_test'
);
```

If using service role key (server-side), this should succeed.
If using anon key (client-side), this should fail (RLS protection).

### 5. Check from Application

```python
# Test from Python (hetzner-deploy server)
from src.config.supabase_client import get_supabase_client

supabase = get_supabase_client()
result = supabase.table('chart_snapshots').select('*').limit(1).execute()
print(f"‚úÖ Table accessible, {len(result.data)} rows")
```

---

## üîÑ Migration Rollback

If you need to revert a migration:

### Rollback 013_chart_snapshots.sql

```sql
-- Drop the table and all data
DROP TABLE IF EXISTS chart_snapshots CASCADE;

-- Verify
SELECT table_name
FROM information_schema.tables
WHERE table_name = 'chart_snapshots';
-- Should return: empty (0 rows)
```

**‚ö†Ô∏è WARNING:** This will delete all chart snapshot data permanently!

---

## üìä Migration History

### How to Check Applied Migrations

Supabase doesn't have built-in migration tracking like Alembic. To track manually:

```sql
-- Create migration history table (run once)
CREATE TABLE IF NOT EXISTS schema_migrations (
    version VARCHAR(255) PRIMARY KEY,
    applied_at TIMESTAMPTZ DEFAULT NOW()
);

-- After applying each migration, record it
INSERT INTO schema_migrations (version)
VALUES ('013_chart_snapshots');

-- Check what's applied
SELECT * FROM schema_migrations ORDER BY applied_at DESC;
```

---

## üõ†Ô∏è Troubleshooting

### Issue: "relation chart_snapshots already exists"

**Cause:** Migration already applied.

**Solution:**
```sql
-- Check if table exists
SELECT * FROM chart_snapshots LIMIT 1;
```

If it works, migration is already applied. No action needed.

---

### Issue: "permission denied for table chart_snapshots"

**Cause:** RLS policies are blocking access.

**Solution:**
1. Use service role key (server-side only)
2. Or add explicit policy for your use case

```sql
-- Allow service role to bypass RLS
ALTER TABLE chart_snapshots FORCE ROW LEVEL SECURITY;

-- Add policy for service role
CREATE POLICY "Service role can do anything"
ON chart_snapshots
FOR ALL
TO service_role
USING (true)
WITH CHECK (true);
```

---

### Issue: "column user_id cannot be null"

**Cause:** Trying to insert without user_id.

**Solution:**
- Set `user_id` explicitly
- Or make column nullable:

```sql
ALTER TABLE chart_snapshots
ALTER COLUMN user_id DROP NOT NULL;
```

---

### Issue: Migration fails halfway

**Cause:** SQL error in migration file.

**Solution:**
1. Check error message for line number
2. Fix the SQL
3. Rollback (see above)
4. Re-apply fixed migration

---

## üìù Creating New Migrations

When adding new database changes:

### Step 1: Create Migration File

```bash
# Use incremental numbering
cd services/api/supabase/migrations
touch 014_new_feature.sql
```

### Step 2: Write SQL

```sql
-- 014_new_feature.sql
-- Description: Add support for XYZ feature
-- Date: 2025-11-02

-- Create table
CREATE TABLE IF NOT EXISTS new_table (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE new_table ENABLE ROW LEVEL SECURITY;

-- Add policies
CREATE POLICY "Users can read own data"
ON new_table
FOR SELECT
USING (auth.uid() = user_id);
```

### Step 3: Test Locally (Optional)

```bash
# If using Supabase CLI with local dev
supabase start
supabase db push
```

### Step 4: Apply to Production

Follow "Option 1: Supabase Dashboard" above.

### Step 5: Document

Add to this file under "Available Migrations".

---

## üéØ Pre-Deployment Checklist

Before deploying to Hetzner, ensure:

- [ ] Migration 013 applied to Supabase
- [ ] Table `chart_snapshots` exists
- [ ] RLS policies enabled
- [ ] Test insert/select works
- [ ] Python code can access table (test with supabase client)
- [ ] Environment variables set (SUPABASE_URL, SUPABASE_SERVICE_KEY)

---

## üìû Support

If you encounter issues:

1. Check Supabase Dashboard > Logs
2. Check [Supabase Docs](https://supabase.com/docs)
3. Check [Supabase Discord](https://discord.supabase.com)
4. Review this guide's Troubleshooting section

---

**Migration Guide Version:** 1.0
**Last Updated:** 2025-11-02
**Maintainer:** umi1970
